# 产品需求文档（PRD）：本地输入记录器 MVP（输入法方向）

**版本**：1.0  
**日期**：2025-02-11  
**方向说明**：在保留「完全本地、安全」前提下，将产品重构为「三功能输入法/输入助手」——不涉及浏览器插件与 AI 记忆卡。

---

## 1. 执行摘要

### 问题陈述

用户希望有一个**完全本地、安全**的输入相关工具，能：  
（1）把**所有输入的内容**保存到本地；（2）把**所有粘贴的内容**保存到本地；（3）能**指定任意内容**也保存到本地，且**不影响正常打字**。

### 提案（一句话）

**本地输入记录器**：三项能力——键入即存、粘贴即存、指定即存；数据 100% 存本地，不替代现有输入法即可正常打字（或可选作为“记录型”输入法使用）。

### 成功标准（可验证）

| 指标 | 说明 | 验证方式 |
|------|------|----------|
| 键入可存 | 用户键入的内容能按预期写入本地存储 | 功能测试 + 存储检查 |
| 粘贴可存 | 用户粘贴的内容能写入本地存储 | 功能测试 + 存储检查 |
| 指定可存 | 用户可选中/指定任意内容并保存到本地，且可继续打字 | 功能测试 |
| 完全本地 | 无任何数据上传、无联网依赖 | 代码/网络审查 + 可选断网测试 |
| 正常打字 | 使用过程中不影响或最小化影响原有输入体验 | 主观体验 + 无焦点抢夺 |

### Why Now

- 隐私敏感用户对「输入内容只留在本机」的需求明确。
- 三功能边界清晰，适合用开源项目做最小改造、快速验证。

---

## 2. 用户与功能

### 用户角色

- **主用户**：注重隐私、希望把所有输入/粘贴/指定内容留存在本地的用户（写作者、开发者、笔记用户等）。
- **诉求**：数据不出设备、可回溯或备份自己的输入历史；不破坏现有输入习惯。

### 核心能力（仅三件事）

| 能力 | 说明 | 优先级 |
|------|------|--------|
| 1. 键入即存 | 用户通过键盘输入的内容，在本地有一份记录（见下文实现路径） | Must |
| 2. 粘贴即存 | 用户执行粘贴时，被粘贴的内容同时写入本地存储 | Must |
| 3. 指定即存 | 用户可指定任意一段内容（如选中文本）保存到本地，且保存后仍可正常继续打字 | Must |

### User Stories 与验收标准

#### Epic 1：粘贴即存

**Story 1.1**  
作为用户，我希望每次粘贴时，被粘贴的内容自动保存到本地，且不影响粘贴到目标应用的结果。

- **AC**
  - 监听系统剪贴板变化（或粘贴事件），将新写入剪贴板的内容追加写入本地存储（如 SQLite/JSON/纯文本）。
  - 粘贴行为本身与未安装本工具时一致（目标应用仍收到粘贴内容）。
  - 数据仅存于本机指定目录，无上传。

---

#### Epic 2：指定即存

**Story 2.1**  
作为用户，我希望通过快捷键或按钮，把当前选中的内容保存到本地，且不打断我继续输入。

- **AC**
  - 用户选中任意文本后，通过全局快捷键（如 Cmd+Shift+S）或菜单栏/悬浮入口触发「保存选中内容」。
  - 选中内容写入本地存储，并可选显示简短确认（如 Toast）；不抢夺焦点、不阻塞输入。
  - 支持“指定”的来源包括但不限于：任意可选中文本的应用（浏览器、编辑器、输入框等）。

**Story 2.2**  
作为用户，我希望“指定保存”不依赖我先把内容复制到剪贴板（即选中即存，而非必须复制）。

- **AC**
  - 通过系统可访问性 API（如 macOS 的 AX 或模拟 Cmd+C 后读剪贴板）获取选中内容并保存；或明确文档化「需先复制再触发」的简化实现，并在后续迭代中优化为选中即存。

---

#### Epic 3：键入即存

**Story 3.1**  
作为用户，我希望我键入的内容也能保存到本地，且我仍能像平时一样使用系统默认输入法打字。

- **AC**
  - **方案 A（轻量）**：在“不替换系统输入法”的前提下，通过全局按键监听（如 CGEventTap）记录按键；需在文档中说明：对中文/日文等需要“组字”的输入法，记录的是按键序列或最终上屏结果依实现而定，可能需后续迭代。
  - **方案 B（IME 深度）**：基于开源 IME（如 Rime）改造，在“提交上屏”时把整段提交文本写入本地；用户需切换为该 IME 才能记录键入，但记录的是最终上屏内容，体验完整。
  - 无论哪种方案，键入记录 100% 存本地，且不改变用户在其他应用中的输入表现（方案 B 下仅在用户主动选择该 IME 时生效）。

---

### Non-Goals（明确不做）

- 不做云端同步、不做账号体系、不做数据上传。
- 不做“自动分析/推荐/AI 处理”输入内容（仅存储与可选本地查看）。
- 不做跨设备同步、不做商业化埋点。
- 第一版不承诺“在所有语言/所有输入法下 100% 完整记录键入”（可文档化已知限制，如 CJK 组字）。

---

## 3. 技术规格与开源改造建议

### 难度与可行性概览

| 功能 | 难度 | 说明 |
|------|------|------|
| 粘贴即存 | 低 | 剪贴板监听 + 写入本地文件/DB，实现直接。 |
| 指定即存 | 低～中 | 全局快捷键 + 读取选中内容（剪贴板或可访问性 API） + 写入本地。 |
| 键入即存 | 中～高 | 不替换输入法则需全局按键钩子（CJK 上屏内容难完整）；替换为自研/改造 IME 则开发量大但体验完整。 |

**结论**：三功能在技术上均可实现；MVP 建议先做「粘贴即存 + 指定即存」，再选一条路径做「键入即存」（轻量按键记录 or 改造 IME）。

### 推荐可改造的开源项目

#### 1. 粘贴即存 + 指定即存（优先改造）

| 项目 | 仓库 | 说明 | 改造思路 |
|------|------|------|----------|
| **Maccy** | [p0deje/Maccy](https://github.com/p0deje/Maccy) | macOS 剪贴板历史，Swift，约 18k+ star，MIT，本地 | 在“剪贴板变化”时增加：将内容同时写入本地持久化（如 SQLite/JSON）；增加“保存当前选中”的全局快捷键（通过复制再读剪贴板或 AX 取选中）。 |
| **Yippy** | [mattDavo/Yippy](https://github.com/mattDavo/Yippy) | macOS 剪贴板管理，Swift，MIT | 同上，可做“粘贴即存”+“指定即存”的轻量分支。 |
| **ClipNotes** | [Nathan-Woolmore/ClipNotes](https://github.com/Nathan-Woolmore/ClipNotes) | 剪贴板历史 + 搜索，本地 | 逻辑简单，适合做最小 fork：每次粘贴/复制时多写一份到“输入记录”存储。 |

**推荐**：以 **Maccy** 为基础改造最快——已有剪贴板监听与本地存储习惯，加“持久化到指定格式/目录”和“选中即存”即可。

#### 2. 键入即存（二选一或分阶段）

| 方案 | 项目/技术 | 说明 |
|------|-----------|------|
| **轻量：全局按键监听** | macOS：CGEventTap（如 [CGEventSupervisor](https://github.com/stephancasas/cgeventsupervisor)）、[pynput](https://pypi.org/project/pynput/)（Python）；Windows：类似 hook | 记录按键或简单还原为英文文本；中文/日文等多为“按键码”或需配合 IME 状态解析，MVP 可先支持英文或注明限制。 |
| **完整：改造 IME** | **Rime（中州韵）** [rime/librime](https://github.com/rime/librime)、[rime/squirrel](https://github.com/rime/squirrel)（macOS 前端） | 在“提交上屏”回调中把提交字符串写入本地文件/DB。用户需安装并选用 Rime 作为输入法；体验与现有 Rime 一致，仅多一层本地记录。 |

**推荐**：MVP 先不做 IME 改造，用「粘贴即存 + 指定即存」验证需求；若需“键入即存”，第一版可用**轻量按键监听**（仅英文或注明 CJK 限制），后续再评估是否基于 Rime 做“提交即存”。

### 架构与数据流（轻量方案）

```
[系统剪贴板] ──变化──> [本应用] ──追加写入──> [本地存储]
                              ^
[用户选中 + 快捷键] ──────────┘

[键盘事件] ──(可选) CGEventTap/按键监听──> [本应用] ──写入──> [本地存储]
```

- **本地存储**：单机目录下的 SQLite 或 JSON 文件；可按时间/类型分表或分文件。
- **权限**：macOS 需辅助功能（可访问性）权限（用于全局快捷键、可选选中内容读取）；若用按键监听需输入监听权限。不申请网络权限。

### 安全与隐私

- 所有数据仅写入用户本机指定目录；不联网、不上传、不加密上传。
- 可选：本地存储加密（如用用户提供的密钥或设备密钥），在 PRD 后续版本中补充。
- 不收集任何使用统计到外部服务器。

---

## 4. 交互与体验原则

- **尽量隐形**：无弹窗、不抢占焦点；可选菜单栏图标或托盘入口查看/导出记录。
- **指定即存**：快捷键触发后仅简短确认（如 Toast），不打断当前输入。
- **可选**：设置中允许关闭“键入即存”或“粘贴即存”，仅保留“指定即存”。

---

## 5. 风险与路线图

### 技术风险

| 风险 | 概率 | 影响 | 缓解 |
|------|------|------|------|
| 剪贴板监听被系统限制 | 低 | 粘贴即存漏记 | 使用系统官方剪贴板 API；文档化已知限制（如某些应用的私有粘贴）。 |
| 获取“选中内容”依赖可访问性 | 中 | 部分应用无法取到选中 | 提供降级：先复制再快捷键保存；或仅支持已明确支持的应用列表。 |
| 键入记录在 CJK 下不完整 | 高（若用按键方案） | 用户期望落差 | 文档明确说明 MVP 范围；或优先做 Rime 改造路径。 |
| Rime 改造工作量大 | 中 | 上线延迟 | MVP 先不做；用粘贴+指定验证价值后再排期。 |

### 建议实施节奏（约 14 天）

| 阶段 | 天数 | 内容 |
|------|------|------|
| Day 1–2 | 2 | 选定基础仓库（建议 Maccy fork）；搭本地工程；实现剪贴板监听 + 写入本地存储（粘贴即存）。 |
| Day 3–4 | 2 | 全局快捷键 + “选中即存”（复制后读剪贴板 或 AX 取选中）；简单列表/导出界面（可选）。 |
| Day 5–7 | 3 | 指定即存打磨；设置项（存储路径、开关）；完整本地存储格式与隐私说明。 |
| Day 8–10 | 3 | 键入即存：实现轻量按键监听（如仅英文）或启动 Rime 改造调研；文档化限制。 |
| Day 11–14 | 4 | 联调、权限与上架说明（如需要）、自测与内测。 |

---

## 6. 附录 A：需求追溯与开源项目一览

| 业务目标 | 功能 | 可选开源基础 |
|----------|------|--------------|
| 粘贴即存 | Epic 1 | Maccy, Yippy, ClipNotes |
| 指定即存 | Epic 2 | 同上 + 全局快捷键/可访问性 |
| 键入即存 | Epic 3 | CGEventSupervisor / pynput（轻量）；Rime/librime（完整） |

---

## 7. 附录 B：现成开源 IME 改造调研（键入即存）

以下为「键入即存」选“改造现有 IME”时，可直接参考的现成项目与接入点。

### 7.1 Rime（中州韵）——首选可改造 IME

| 项目 | 仓库 | 平台 | 说明 |
|------|------|------|------|
| **librime** | [rime/librime](https://github.com/rime/librime) | 引擎，跨平台 | 提供 C API，**提交文本**通过 `get_commit(session_id, RimeCommit* commit)` 获取，`commit.text` 即为本次上屏内容。 |
| **鼠须管 Squirrel** | [rime/squirrel](https://github.com/rime/squirrel) | macOS | 纯 Swift，已用 `RimeCommit` 等结构（见 `sources/BridgingFunctions.swift`）；提交逻辑在输入流程中调用 `get_commit` 后把文本交给系统。改造点：在**每次取到 commit 并上屏之后**，把 `commit.text` 追加写入本地文件或 DB。 |
| **小狼毫 Weasel** | [rime/weasel](https://github.com/rime/weasel) | Windows | C++，同样依赖 librime；在“处理按键 → get_commit → 上屏”的链路中加一层“若 commit 非空则写入本地”即可。 |
| **fcitx-rime** | [fcitx/fcitx-rime](https://github.com/fcitx/fcitx-rime) | Linux (Fcitx) | 插件里已有 `FcitxRimeDoInputReal` → `process_key` → `get_commit`；在取到 `commit.text` 后写入本地即完成“提交即存”。 |

**librime API 要点（`rime_api.h`）**：

- `Bool (*get_commit)(RimeSessionId session_id, RimeCommit* commit);`  
- `typedef struct rime_commit_t { int data_size; char* text; } RimeCommit;`  
- 使用后需 `free_commit` 释放。  

**改造步骤（以 Squirrel 为例）**：

1. 在仓库中搜索调用 `get_commit` 或处理“上屏”的位置（通常在 `SquirrelInputController.swift` 或与 `commit` 相关的逻辑）。
2. 在“取得 commit 且 text 非空”的分支中，增加：将 `commit.text` 写入本地存储（文件追加或 SQLite）。
3. 不改变原有上屏行为，仅增加一条写盘逻辑；数据目录可放在 `~/Library/Application Support/YourApp/` 等。

**优点**：用户继续用 Rime 输入，无感获得“每句上屏都存一份”；支持中英日等所有方案。**代价**：用户需安装并选用 Rime 作为当前输入法。

---

### 7.2 Fcitx5（Linux 平台）

| 项目 | 说明 |
|------|------|
| **fcitx5** | [fcitx/fcitx5](https://github.com/fcitx/fcitx5) 模块化输入法框架，C++，支持插件与事件回调。 |
| **fcitx5-rime** | 在 Fcitx5 上跑 Rime 引擎；提交路径与 fcitx-rime 类似，在拿到提交文本后加写本地即可。 |
| **Fcitx5 macOS** | [fcitx-contrib/fcitx5-macos](https://github.com/fcitx-contrib/fcitx5-macos) 等，若采用 Rime 后端，同样可在提交链路上加“提交即存”。 |

适合**主要用 Linux 或 Fcitx 系**的改造；若目标用户以 macOS/Windows 为主，优先 Rime 官方前端（Squirrel/Weasel）。

---

### 7.3 Keyman

| 项目 | 仓库 | 说明 |
|------|------|------|
| **Keyman** | [keymanapp/keyman](https://github.com/keymanapp/keyman) | 跨平台（含 Windows、macOS、Linux、Web），键盘布局与词库丰富。 |
| 改造点 | 需查其 IME 层文档（如 [Input Method Extensions](https://help.keyman.com/developer/18.0/guides/develop/imx)）中“输出/提交”的 API 或回调，在提交文本时写入本地。 |

架构与 Rime 不同，需单独看文档和源码确定“提交文本”的暴露方式；作为 Rime 的备选方案。

---

### 7.4 其他开源 IME（简要）

| 项目 | 平台 | 说明 |
|------|------|------|
| **Mozc** | [google/mozc](https://github.com/google/mozc) | 多平台，日文输入为主；若做日文“提交即存”可考虑，代码量大。 |
| **Lipika IME** | [ratreya/lipika-ime](https://github.com/ratreya/lipika-ime) | macOS，印度诸语言；面向特定语种，通用“键入即存”优先 Rime。 |
| **zhime** | [zhangkaiser/zhime](https://github.com/zhangkaiser/zhime) | Chrome OS / Web，MIT；若做浏览器内输入记录可参考，与桌面“系统级键入即存”场景不同。 |

---

### 7.5 改造难度与推荐顺序（键入即存）

| 顺序 | 方案 | 难度 | 说明 |
|------|------|------|------|
| 1 | **Rime（Squirrel / Weasel / fcitx-rime）** | 中 | API 明确（`get_commit` + `commit.text`），前端已有完整输入与上屏流程，仅加写盘；文档与社区多。 |
| 2 | **Fcitx5 + Rime** | 中 | 与 1 类似，适合 Linux 用户。 |
| 3 | **Keyman** | 中～高 | 需单独查提交/输出接口，跨平台一致性好。 |
| 4 | **Mozc / Lipika 等** | 高 | 针对特定语言或平台，通用“所有输入都存”优先选 Rime。 |

**结论**：若要“现成开源 IME 改造”实现键入即存，**优先选 Rime 体系**（macOS 用 Squirrel、Windows 用 Weasel、Linux 用 fcitx-rime），在现有 `get_commit` 使用处增加对 `commit.text` 的本地持久化即可，改动面小、行为可预期。

---

*本文档按 PRD/产品相关 skills（prd、product-manager、writing-prds）规范撰写，聚焦完全本地、三功能、可改造开源的 MVP。*
